# The Last of Guss - Backend

Backend —Å–µ—Ä–≤–µ—Ä –¥–ª—è –∏–≥—Ä—ã "The Last of Guss", —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ Fastify —Å TypeScript.

## üöÄ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** - JWT-based –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–æ–ª–µ–π (user, admin, nikita)
- **–°–∏—Å—Ç–µ–º–∞ —Ä–∞—É–Ω–¥–æ–≤** - –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–≤—ã–º–∏ —Ä–∞—É–Ω–¥–∞–º–∏ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–æ–≤
- **Tap-–º–µ—Ö–∞–Ω–∏–∫–∞** - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ —Å —Å–∏—Å—Ç–µ–º–æ–π –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –æ—á–∫–æ–≤
- **–û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á** - Redis-based –æ—á–µ—Ä–µ–¥—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–∞–ø–æ–≤ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
- **–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤** - –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –æ—á–∫–æ–≤ –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- **–ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** - –ì–∞—Ä–∞–Ω—Ç–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- **Rate limiting** - –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ –∏ —á—Ä–µ–∑–º–µ—Ä–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
- **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** - –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ SPA** - –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–¥–∞—á–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ —Å fallback –Ω–∞ index.html

## üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **Fastify** - –í–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **TypeScript** - –¢–∏–ø–∏–∑–∞—Ü–∏—è
- **PostgreSQL** - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **Redis** - –û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- **Sequelize** - ORM
- **JWT** - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Node.js 18+
- PostgreSQL 12+
- Redis 6+ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
npm install
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ backend –ø–∞–∫–µ—Ç–∞:
```env
# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
DB_HOST=localhost
DB_PORT=5432
DB_NAME=the_last_of_guss
DB_USER=postgres
DB_PASSWORD=password

# JWT
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=7d

# Redis (–¥–ª—è –æ—á–µ—Ä–µ–¥–∏)
REDIS_URL=redis://localhost:6379
USE_TAP_QUEUE=false

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã
ROUND_DURATION=60
COOLDOWN_DURATION=30
TAP_COOLDOWN_MS=50
MAX_TAPS_PER_SECOND=10

# –°–µ—Ä–≤–µ—Ä
PORT=3019
NODE_ENV=development
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

#### –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```bash
npm run db:create
```

#### –ú–∏–≥—Ä–∞—Ü–∏–∏
```bash
npm run migrate:up
```

#### –°–±—Ä–æ—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```bash
npm run db:reset
```

### –ó–∞–ø—É—Å–∫

#### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
```bash
npm run dev
```

#### –ü—Ä–æ–¥–∞–∫—à–µ–Ω
```bash
npm run build
npm run start
```

## üóÑ API Endpoints

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- `POST /api/auth/login` - –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
- `POST /api/auth/logout` - –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
- `GET /api/auth/me` - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –†–∞—É–Ω–¥—ã
- `GET /api/rounds` - –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–∞—É–Ω–¥–æ–≤
- `GET /api/rounds/:id` - –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞—É–Ω–¥–∞ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
- `POST /api/rounds` - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞ (—Ç—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ admin)

### –¢–∞–ø—ã (–∫–ª–∏–∫–∏)
- `POST /api/rounds/:roundId/tap` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞
- `GET /api/tap/status/:taskId` - –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ —Ç–∞–ø–∞ (–ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –æ—á–µ—Ä–µ–¥–∏)

## üéÆ –ò–≥—Ä–æ–≤–∞—è –º–µ—Ö–∞–Ω–∏–∫–∞

### –°–∏—Å—Ç–µ–º–∞ –æ—á–∫–æ–≤
- –û–±—ã—á–Ω—ã–π –∫–ª–∏–∫: +1 –æ—á–∫–æ
- –ö–∞–∂–¥—ã–π 11-–π –∫–ª–∏–∫: +10 –æ—á–∫–æ–≤
- –û–±—â–∏–π —Å—á–µ—Ç —Ä–∞—É–Ω–¥–∞ —Å—É–º–º–∏—Ä—É–µ—Ç—Å—è –∏–∑ –æ—á–∫–æ–≤ –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

### –°—Ç–∞—Ç—É—Å—ã —Ä–∞—É–Ω–¥–æ–≤
- **cooldown** - –û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞
- **active** - –ê–∫—Ç–∏–≤–Ω—ã–π —Ä–∞—É–Ω–¥
- **finished** - –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π —Ä–∞—É–Ω–¥

### –û—Å–æ–±—ã–µ —Ä–æ–ª–∏
- **nikita** - –¢–∞–ø—ã –Ω–µ –∑–∞—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è (–¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏)
- **admin** - –ü—Ä–∞–≤–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—É–Ω–¥–æ–≤

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–ø–æ–≤
```env
TAP_COOLDOWN_MS=50          # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Ç–∞–ø–∞–º–∏ (–º—Å)
MAX_TAPS_PER_SECOND=10      # –ú–∞–∫—Å–∏–º—É–º —Ç–∞–ø–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É
USE_TAP_QUEUE=false         # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Redis –æ—á–µ—Ä–µ–¥–∏
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—É–Ω–¥–æ–≤
```env
ROUND_DURATION=60           # –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞—É–Ω–¥–∞ (—Å–µ–∫)
COOLDOWN_DURATION=30        # –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º (—Å–µ–∫)
```

## üóÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/
‚îú‚îÄ‚îÄ controllers/          # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã API
‚îú‚îÄ‚îÄ services/            # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îú‚îÄ‚îÄ middleware/          # –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û
‚îú‚îÄ‚îÄ routes/              # –ú–∞—Ä—à—Ä—É—Ç—ã API
‚îú‚îÄ‚îÄ types/               # TypeScript —Ç–∏–ø—ã
‚îî‚îÄ‚îÄ index.ts            # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
```

## üîß –°–∫—Ä–∏–ø—Ç—ã

- `npm run dev` - –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- `npm run build` - –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
- `npm run start` - –ó–∞–ø—É—Å–∫ —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- `npm run db:create` - –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- `npm run migrate:up` - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
- `npm run db:reset` - –°–±—Ä–æ—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Health check
```bash
GET /health
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–µ—Ä–µ–¥–∏ (–ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏)
```javascript
// –í –∫–æ–¥–µ
QueueService.debugQueue()
```

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–í —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –≤–∫–ª—é—á–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º pino-pretty.

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
```env
NODE_ENV=development
LOG_LEVEL=debug
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- JWT —Ç–æ–∫–µ–Ω—ã —Å HTTP-only cookies
- CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- Rate limiting
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- SQL injection protection —á–µ—Ä–µ–∑ Sequelize

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –°–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å—ã —Ä–∞—É–Ω–¥–æ–≤ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
- –î–ª—è –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–∫–ª—é—á–∏—Ç—å `USE_TAP_QUEUE=true`
- –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –æ–±—Å–ª—É–∂–∏–≤–∞—é—Ç—Å—è –∏–∑ –ø–∞–ø–∫–∏ `public/`
- SPA routing –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ fallback –Ω–∞ index.html