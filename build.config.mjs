import esbuild from 'esbuild'
import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

class CSSBundler {
    constructor(basePath) {
        this.basePath = basePath
        this.cssImports = new Map()
        this.cssContent = new Map()
        this.componentCSSMap = new Map() // –ö–∞—Ä—Ç–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç -> CSS
    }

    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ CSS —Ñ–∞–π–ª—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ
    async findCSSFiles(dir) {
        const files = []

        async function scanDirectory(currentDir) {
            const entries = await fs.promises.readdir(currentDir, { withFileTypes: true })

            for (const entry of entries) {
                const fullPath = path.join(currentDir, entry.name)

                if (entry.isDirectory()) {
                    await scanDirectory(fullPath)
                } else if (entry.isFile() && path.extname(entry.name) === '.css') {
                    files.push(fullPath)
                }
            }
        }

        await scanDirectory(dir)
        return files
    }

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º CSS —Ñ–∞–π–ª—ã –∏ —Å–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    async processCSSFiles(cssFiles) {
        for (const filePath of cssFiles) {
            const content = await fs.promises.readFile(filePath, 'utf-8')
            const relativePath = path.relative(this.basePath, filePath)

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º @import –ø—Ä–∞–≤–∏–ª–∞
            const processedContent = await this.processCSSImports(content, path.dirname(filePath))
            this.cssContent.set(relativePath, processedContent)

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫ –∫–∞–∫–æ–º—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è CSS
            const componentName = this.extractComponentName(relativePath)
            if (componentName) {
                if (!this.componentCSSMap.has(componentName)) {
                    this.componentCSSMap.set(componentName, [])
                }
                this.componentCSSMap.get(componentName).push(relativePath)
            }
        }
    }

    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∏–∑ –ø—É—Ç–∏ –∫ CSS
    extractComponentName(cssPath) {
        const match = cssPath.match(/components\/([^\/]+)\/css\//)
        return match ? match[1] : null
    }

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º @import –≤ CSS
    async processCSSImports(content, baseDir) {
        const importRegex = /@import\s+(?:url\()?['"]([^'"]+)['"](?:\))?\s*;/g
        let processedContent = content

        let match
        while ((match = importRegex.exec(content)) !== null) {
            const importPath = match[1]
            const fullImportPath = path.resolve(baseDir, importPath)

            if (fs.existsSync(fullImportPath)) {
                const importedContent = await fs.promises.readFile(fullImportPath, 'utf-8')
                const nestedContent = await this.processCSSImports(importedContent, path.dirname(fullImportPath))
                processedContent = processedContent.replace(match[0], nestedContent)
            }
        }

        return processedContent
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –µ–¥–∏–Ω—ã–π CSS –±–∞–Ω–¥–ª
    generateCSSBundle() {
        let bundle = '/* CSS Bundle - Generated by esbuild */\n'

        for (const [filePath, content] of this.cssContent) {
            bundle += `\n/* ${filePath} */\n`
            bundle += content
            bundle += '\n'
        }

        return bundle
    }

    // –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è CSS —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    createCSSModule() {
        const cssBundle = this.generateCSSBundle()
        const cssPaths = Array.from(this.cssContent.keys())

        return `
      const cssContent = ${JSON.stringify(cssBundle)};
      const cssPaths = ${JSON.stringify(cssPaths)};
      const componentCSSMap = ${JSON.stringify(Object.fromEntries(this.componentCSSMap))};
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSS –ø–æ –ø—É—Ç–∏
      export function getCSSByPath(filePath) {
        const normalizedPath = filePath.replace(/\\\\/g, '/');
        const entry = cssPaths.find(path => path.replace(/\\\\/g, '/').includes(normalizedPath));
        
        if (entry) {
          const startMarker = '/* ' + entry + ' */';
          const startIndex = cssContent.indexOf(startMarker) + startMarker.length;
          let endIndex = cssContent.length;
          
          // –ò—â–µ–º —Å–ª–µ–¥—É—é—â–∏–π –º–∞—Ä–∫–µ—Ä
          for (let i = cssPaths.indexOf(entry) + 1; i < cssPaths.length; i++) {
            const nextMarker = '/* ' + cssPaths[i] + ' */';
            const nextIndex = cssContent.indexOf(nextMarker);
            if (nextIndex !== -1) {
              endIndex = nextIndex;
              break;
            }
          }
          
          return cssContent.substring(startIndex, endIndex).trim();
        }
        return null;
      }
      
      // –ü–æ–ª—É—á–∏—Ç—å CSS –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –ø–æ –∏–º–µ–Ω–∏
      export function getCSSForComponent(componentName) {
        const componentPaths = componentCSSMap[componentName];
        if (!componentPaths) return null;
        
        return componentPaths.map(path => getCSSByPath(path)).filter(Boolean).join('\\n');
      }
      
      // –ü–æ–ª—É—á–∏—Ç—å –≤–µ—Å—å CSS
      export function getAllCSS() {
        return cssContent;
      }
      
      // –í—Å—Ç–∞–≤–∏—Ç—å CSS –≤ –¥–æ–∫—É–º–µ–Ω—Ç
      export function injectCSS() {
        if (typeof document !== 'undefined') {
          const style = document.createElement('style');
          style.textContent = cssContent;
          document.head.appendChild(style);
        }
      }
      
      // –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö CSS –ø—É—Ç–µ–π
      export function getCSSPaths() {
        return cssPaths;
      }
      
      // –ü–æ–ª—É—á–∏—Ç—å CSS –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—É—Ç–µ–π
      export function getMultipleCSS(paths) {
        return paths.map(path => getCSSByPath(path)).filter(Boolean).join('\\n');
      }
      
      // –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ä—Ç—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
      export function getComponentCSSMap() {
        return componentCSSMap;
      }
      
      // –≠–∫—Å–ø–æ—Ä—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –≤–µ—Å—å CSS
      export default cssContent;
    `
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±–æ—Ä–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–±–æ—Ä–∫–∏
export async function generateBuildStats(config, result, cssBundler, startTime) {
    const endTime = Date.now();
    const buildTime = endTime - startTime;

    // –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–∞—Ö
    const fileTypes = {
        css: { count: 0, totalSize: 0 },
        js: { count: 0, totalSize: 0 },
        mjs: { count: 0, totalSize: 0 },
        html: { count: 0, totalSize: 0 },
        other: { count: 0, totalSize: 0 }
    };

    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º CSS —Ñ–∞–π–ª—ã - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ
    const cssFiles = cssBundler.cssFiles || [];
    cssFiles.forEach(filePath => {
        try {
            const stats = fs.statSync(filePath);
            fileTypes.css.count++;
            fileTypes.css.totalSize += stats.size;
        } catch (error) {
            console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è CSS —Ñ–∞–π–ª–∞: ${filePath}`);
        }
    });

    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
    function analyzeDirectory(dir) {
        try {
            const files = fs.readdirSync(dir, { withFileTypes: true });

            for (const file of files) {
                const fullPath = path.join(dir, file.name);

                if (file.isDirectory()) {
                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º node_modules –∏ —Å–∫—Ä—ã—Ç—ã–µ –ø–∞–ø–∫–∏
                    if (!file.name.includes('node_modules') && !file.name.startsWith('.')) {
                        analyzeDirectory(fullPath);
                    }
                } else if (file.isFile()) {
                    try {
                        const stats = fs.statSync(fullPath);
                        const ext = path.extname(file.name).toLowerCase();

                        if (ext === '.js') {
                            fileTypes.js.count++;
                            fileTypes.js.totalSize += stats.size;
                        } else if (ext === '.mjs') {
                            fileTypes.mjs.count++;
                            fileTypes.mjs.totalSize += stats.size;
                        } else if (ext === '.html') {
                            fileTypes.html.count++;
                            fileTypes.html.totalSize += stats.size;
                        } else if (ext === '.css') {
                            // –£–∂–µ —É—á—Ç–µ–Ω—ã –≤ CSS –∞–Ω–∞–ª–∏–∑–µ
                        } else {
                            fileTypes.other.count++;
                            fileTypes.other.totalSize += stats.size;
                        }
                    } catch (error) {
                        console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª: ${fullPath}`);
                    }
                }
            }
        } catch (error) {
            console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: ${dir}`);
        }
    }

    try {
        analyzeDirectory(config.projectRoot);
    } catch (error) {
        console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: ${config.projectRoot}`);
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã
    const formatSize = (bytes) => {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    };

    // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    let outputSize = 'N/A';
    try {
        if (fs.existsSync(config.outfile)) {
            const stats = fs.statSync(config.outfile);
            outputSize = formatSize(stats.size);
        }
    } catch (error) {
        console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: ${config.outfile}`);
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    const stats = {
        project: path.basename(config.projectRoot),
        buildTime: `${buildTime}ms (${(buildTime / 1000).toFixed(2)}s)`,
        outputFile: config.outfile,
        outputSize: outputSize,
        css: {
            files: cssFiles.length,
            components: cssBundler.componentCSSMap?.size || 0,
            totalSize: formatSize(fileTypes.css.totalSize)
        },
        sourceFiles: {
            js: fileTypes.js.count,
            mjs: fileTypes.mjs.count,
            html: fileTypes.html.count,
            other: fileTypes.other.count,
            total: fileTypes.js.count + fileTypes.mjs.count + fileTypes.html.count + fileTypes.other.count
        },
        timings: {
            start: new Date(startTime).toLocaleTimeString(),
            end: new Date(endTime).toLocaleTimeString(),
            duration: buildTime
        }
    };

    return stats;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ README.md
export async function generateReadme(projectName, config, stats) {
    const readmePath = path.join(path.dirname(config.outfile), 'README.md');

    const readmeContent = `# ${projectName.toUpperCase()} Project Bundle

## üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ

- **–ü—Ä–æ–µ–∫—Ç**: ${projectName}
- **–í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏**: ${stats.buildTime}
- **–í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª**: ${path.basename(config.outfile)}
- **–†–∞–∑–º–µ—Ä –±–∞–Ω–¥–ª–∞**: ${stats.outputSize}

## üóÇÔ∏è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±–æ—Ä–∫–∏

### –§–∞–π–ª—ã CSS
- **CSS —Ñ–∞–π–ª–æ–≤**: ${stats.css.files}
- **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–æ —Å—Ç–∏–ª—è–º–∏**: ${stats.css.components}
- **–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä CSS**: ${stats.css.totalSize}

### –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
- **JavaScript —Ñ–∞–π–ª–æ–≤ (.js)**: ${stats.sourceFiles.js}
- **ES –º–æ–¥—É–ª–µ–π (.mjs)**: ${stats.sourceFiles.mjs}
- **HTML —Ñ–∞–π–ª–æ–≤**: ${stats.sourceFiles.html}
- **–ü—Ä–æ—á–∏—Ö —Ñ–∞–π–ª–æ–≤**: ${stats.sourceFiles.other}
- **–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤**: ${stats.sourceFiles.total}

## üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
\`\`\`bash
# –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
cd /10/docs

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä
npm run dev

# –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
open http://localhost:6832/${projectName}
\`\`\`

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä—è–º–æ–π –∑–∞–ø—É—Å–∫ HTML —Ñ–∞–π–ª–∞
\`\`\`bash
# –û—Ç–∫—Ä–æ–π—Ç–µ HTML —Ñ–∞–π–ª –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ
open ./${projectName}/public/index.html

# –ò–ª–∏ —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
npx serve ./${projectName}/public
\`\`\`

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ —Å–±–æ—Ä–∫—É
\`\`\`bash
# –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
npm run build:${projectName}

# –°–±–æ—Ä–∫–∞ –≤ —Ä–µ–∂–∏–º–µ watch
npm run build:${projectName}:watch
\`\`\`

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

\`\`\`
${projectName}/
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îú‚îÄ‚îÄ index.html          # –û—Å–Ω–æ–≤–Ω–æ–π HTML —Ñ–∞–π–ª
‚îÇ   ‚îî‚îÄ‚îÄ index.bundle.mjs    # –°–æ–±—Ä–∞–Ω–Ω—ã–π –±–∞–Ω–¥–ª
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ components/         # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ base/              # –ë–∞–∑–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã
‚îÇ   ‚îî‚îÄ‚îÄ index.mjs          # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îî‚îÄ‚îÄ ...
\`\`\`

## üîß –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

- \`npm run build:${projectName}\` - –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–∞—è —Å–±–æ—Ä–∫–∞
- \`npm run build:${projectName}:watch\` - —Å–±–æ—Ä–∫–∞ —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π
- \`npm run dev\` - –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

## ‚è±Ô∏è –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ —Å–±–æ—Ä–∫–∏

- **–ù–∞—á–∞–ª–æ**: ${stats.timings.start}
- **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ**: ${stats.timings.end}
- **–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: ${stats.timings.duration}ms

---

*–°–æ–±—Ä–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ${new Date().toLocaleString()}*
`;

    try {
        await fs.promises.writeFile(readmePath, readmeContent, 'utf-8');
        console.log(`üìñ README.md —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: ${readmePath}`);
        return true;
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ README.md:', error);
        return false;
    }
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–±–æ—Ä–∫–∏
export async function buildProject(config) {
    const {
        entryPoint,
        outfile,
        projectRoot,
        watch = false
    } = config

    console.log(`Starting build for: ${entryPoint}`)
    console.log(`Project root: ${projectRoot}`)
    console.log(`Output: ${outfile}`)
    console.log(`Watch mode: ${watch}`)

    const cssBundler = new CSSBundler(projectRoot)
    const startTime = Date.now()

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ CSS
    const reloadCSS = async () => {
        try {
            const cssFiles = await cssBundler.findCSSFiles(projectRoot)
            console.log(`üîÑ Reloading ${cssFiles.length} CSS files`)
            await cssBundler.processCSSFiles(cssFiles)
            return true
        } catch (error) {
            console.error('‚ùå CSS reload failed:', error)
            return false
        }
    }

    try {
        // –ù–∞—Ö–æ–¥–∏–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ CSS —Ñ–∞–π–ª—ã
        const cssFiles = await cssBundler.findCSSFiles(projectRoot)
        console.log(`Found ${cssFiles.length} CSS files`)
        await cssBundler.processCSSFiles(cssFiles)

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è esbuild
        const buildConfig = {
            entryPoints: [entryPoint],
            bundle: true,
            sourcemap: true,
            format: 'esm',
            target: 'chrome114',
            platform: 'browser',
            outfile,
            keepNames: true,
            metafile: true, // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞—Ñ–∞–π–ª –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            define: {
                global: 'window'
            },
            plugins: [
                {
                    name: 'css-bundler',
                    setup(build) {
                        // –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è CSS
                        build.onResolve({ filter: /^virtual:css$/ }, args => {
                            return { path: 'virtual:css', namespace: 'virtual-css' }
                        })

                        build.onLoad({ filter: /^virtual:css$/, namespace: 'virtual-css' }, () => {
                            return {
                                contents: cssBundler.createCSSModule(),
                                loader: 'js'
                            }
                        })

                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ CSS –∏–º–ø–æ—Ä—Ç–æ–≤ –≤ JS - —Ç–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –±–∞–Ω–¥–ª–∞
                        build.onLoad({ filter: /\.css$/ }, async (args) => {
                            try {
                                const relativePath = path.relative(projectRoot, args.path)
                                const componentName = cssBundler.extractComponentName(relativePath)

                                return {
                                    contents: `
                    import { getCSSByPath, getCSSForComponent } from 'virtual:css';
                    
                    const cssContent = getCSSByPath('${relativePath}') || '';
                    const componentCSS = ${componentName ? `getCSSForComponent('${componentName}')` : 'null'};
                    
                    export const cssContent = cssContent;
                    export const componentCSS = componentCSS;
                    export const cssPath = '${relativePath}';
                    export const componentName = '${componentName}';
                    export default cssContent;
                  `,
                                    loader: 'js'
                                }
                            } catch (error) {
                                console.error(`Error processing CSS file ${args.path}:`, error)
                                return {
                                    contents: `export default ''; export const cssContent = ''; export const cssPath = '';`,
                                    loader: 'js'
                                }
                            }
                        })
                    }
                }
            ]
        }

        let result;

        if (watch) {
            // –î–ª—è watch mode –∏—Å–ø–æ–ª—å–∑—É–µ–º context
            const context = await esbuild.context(buildConfig)

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ CSS
            const rebuildWithCSS = async () => {
                await reloadCSS()
                try {
                    await context.rebuild()
                    console.log('‚úÖ Build updated with latest CSS')
                } catch (error) {
                    console.error('‚ùå Rebuild failed:', error)
                }
            }

            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è CSS —Ñ–∞–π–ª–æ–≤
            const cssWatchers = new Map()

            const setupCSSWatchers = async () => {
                const cssFiles = await cssBundler.findCSSFiles(projectRoot)

                // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –≤–æ—Ç—á–µ—Ä—ã
                for (const [filePath, watcher] of cssWatchers) {
                    watcher.close()
                    cssWatchers.delete(filePath)
                }

                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –≤–æ—Ç—á–µ—Ä—ã –¥–ª—è CSS —Ñ–∞–π–ª–æ–≤
                for (const filePath of cssFiles) {
                    try {
                        const watcher = fs.watch(filePath, async (eventType) => {
                            if (eventType === 'change') {
                                console.log(`üé® CSS changed: ${path.relative(projectRoot, filePath)}`)
                                await rebuildWithCSS()
                            }
                        })
                        cssWatchers.set(filePath, watcher)
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Cannot watch CSS file: ${filePath}`)
                    }
                }
            }

            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–æ—Ç—á–µ—Ä—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            await setupCSSWatchers()

            // –¢–∞–∫–∂–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø–æ—è–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö CSS —Ñ–∞–π–ª–æ–≤
            const cssDirWatcher = fs.watch(projectRoot, { recursive: true }, async (eventType, filename) => {
                if (filename && filename.endsWith('.css')) {
                    console.log(`üìÅ CSS file ${eventType}: ${filename}`)
                    await setupCSSWatchers()
                    await rebuildWithCSS()
                }
            })

            console.log(`üëÄ Watching for changes in ${projectRoot}...`)
            console.log(`üé® CSS files watching: ${cssWatchers.size} files`)

            // –ó–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Ç—á–µ—Ä esbuild
            await context.watch()

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ graceful shutdown
            const cleanup = async () => {
                console.log('\nüßπ Cleaning up watchers...')

                // –ó–∞–∫—Ä—ã–≤–∞–µ–º CSS –≤–æ—Ç—á–µ—Ä—ã
                for (const [filePath, watcher] of cssWatchers) {
                    watcher.close()
                }
                cssWatchers.clear()

                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–Ω—ã–π –≤–æ—Ç—á–µ—Ä
                cssDirWatcher.close()

                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç esbuild
                await context.dispose()

                console.log('üëã All watchers stopped')
                process.exit(0)
            }

            process.on('SIGINT', cleanup)
            process.on('SIGTERM', cleanup)

            return context
        } else {
            // –û–±—ã—á–Ω–∞—è —Å–±–æ—Ä–∫–∞
            result = await esbuild.build(buildConfig)

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const stats = await generateBuildStats(config, result, {
                cssFiles: cssFiles,
                componentCSSMap: cssBundler.componentCSSMap
            }, startTime)

            // –í—ã–≤–æ–¥–∏–º –∫—Ä–∞—Å–∏–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            console.log(`\nüìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ë–û–†–ö–ò ${path.basename(projectRoot).toUpperCase()}`)
            console.log(`‚ïê`.repeat(50))
            console.log(`üèÅ –í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏: ${stats.buildTime}`)
            console.log(`üì¶ –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: ${stats.outputFile}`)
            console.log(`üìè –†–∞–∑–º–µ—Ä –±–∞–Ω–¥–ª–∞: ${stats.outputSize}`)
            console.log(``)
            console.log(`üé® CSS —Ñ–∞–π–ª—ã: ${stats.css.files} (${stats.css.totalSize})`)
            console.log(`üß© –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: ${stats.css.components}`)
            console.log(``)
            console.log(`üìÅ –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã:`)
            console.log(`   ‚îú‚îÄ‚îÄ JavaScript: ${stats.sourceFiles.js}`)
            console.log(`   ‚îú‚îÄ‚îÄ ES –º–æ–¥—É–ª–∏: ${stats.sourceFiles.mjs}`)
            console.log(`   ‚îú‚îÄ‚îÄ HTML: ${stats.sourceFiles.html}`)
            console.log(`   ‚îú‚îÄ‚îÄ –ü—Ä–æ—á–∏–µ: ${stats.sourceFiles.other}`)
            console.log(`   ‚îî‚îÄ‚îÄ –í—Å–µ–≥–æ: ${stats.sourceFiles.total}`)
            console.log(``)
            console.log(`‚è∞ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏:`)
            console.log(`   ‚îú‚îÄ‚îÄ –ù–∞—á–∞–ª–æ: ${stats.timings.start}`)
            console.log(`   ‚îú‚îÄ‚îÄ –ö–æ–Ω–µ—Ü: ${stats.timings.end}`)
            console.log(`   ‚îî‚îÄ‚îÄ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${stats.timings.duration}ms`)
            console.log(`‚ïê`.repeat(50))

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º README
            const projectName = path.basename(projectRoot);
            await generateReadme(projectName, config, stats)

            console.log(`‚úÖ Build completed: ${outfile}`)
            return result
        }
    } catch (error) {
        console.error('‚ùå Build failed:', error)
        throw error
    }
}

// –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞ –ø—Ä–æ–µ–∫—Ç–∞
export function createProjectConfig(projectName, baseDir = __dirname) {
    const projects = {
        chat: {
            entryPoint: './chat/src/index.mjs',
            outfile: './chat/public/index.bundle.mjs',
            projectRoot: path.join(baseDir, 'chat/src')
        },
        youtube: {
            entryPoint: './youtube/public/index.mjs',
            outfile: './youtube/public/index.bundle.mjs',
            projectRoot: path.join(baseDir, 'youtube/src')
        },
        database: {
            entryPoint: './database/public/index.mjs',
            outfile: './database/public/index.bundle.mjs',
            projectRoot: path.join(baseDir, 'database/src')
        },
        wysiwyg: {
            entryPoint: './wysiwyg/public/index.mjs',
            outfile: './wysiwyg/public/index.bundle.mjs',
            projectRoot: path.join(baseDir, 'wysiwyg/src')
        },
        guss: {
            entryPoint: './packages/frontend/src/index.mjs',
            outfile: path.join(baseDir, './packages/public/index.bundle.mjs'),
            projectRoot: path.join(baseDir, './packages/frontend/src')
        }
    }

    return projects[projectName]
}